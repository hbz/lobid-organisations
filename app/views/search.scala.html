@(title: String, q: String, json: String, from: Int, size: Int)

@import play.api.libs.json._

@facet(queryMetadata: JsValue, key: String) = {
 <select onchange="location = '@routes.Application.search()?format=html&from=@from&size=@size&q=@q.trim+AND+' + this.value;">
 <option value="">@key.split("\\.")(0).capitalize</option>
 @for(bucket <- (queryMetadata \ "aggregations" \ key \ "buckets").as[Seq[JsValue]];
      term = (bucket \ "key").as[String];
      count = (bucket \ "doc_count").as[Int]) {
  <option value='@key:"@term"'>@term (@count)</option>
 }
 </select>
}

@main(title) {
 <h1>@title</h1>
 <p>The lobid-organisations service provides access to a comprehensive dataset of library institutions in Germany.</p>
 <form action="@routes.Application.search()" method="GET">
  <input id="search" type="text" autocomplete="off" autofocus name="q" @if(!q.isEmpty) {value="@q"} />
  <input type="hidden" name="format" value="html"/>
  <input type="submit" value="Search"/>
 </form>
 <p>
 @defining(Json.parse(json).as[Seq[JsValue]]) { orgs =>
  @if(orgs.size > 1) {
   Filter by: 
   @facet(orgs(0), "type")
   @facet(orgs(0), "classification.label")
   @facet(orgs(0), "fundertype.label")
   @facet(orgs(0), "stocksize.label")
   <a href='@routes.Application.search(q=q.split("AND")(0).trim, from=from, size=size, format="html")'>Reset all filters</a>
   <p>
    @defining((orgs.head \ "http://sindice.com/vocab/search#totalResults").as[Int]) { totalResults =>
     Total results: @(totalResults) |
     @if(from > 0){<a href='@routes.Application.search(q=q, from=from-size, format="html")'>&LeftArrow; prev</a>}
     @(from+1)&mdash;@(Math.min(totalResults, from+size))
     @if(totalResults > from+size){<a href='@routes.Application.search(q=q, from=from+size, format="html")'>next &RightArrow;</a>}
    }
   </p>
   <table>
    @for(org <- orgs.tail;
         uri = (org\"id").asOpt[String].getOrElse("");
         link = uri.split("#")(0) + "?format=html") {
     <tr>
      <td>
       <a href='@link'>
       @((org\"name").asOpt[String].getOrElse("*no name*"))</a>
      </td>
     </tr>
    }
   </table>
  } else {
   @if(!q.isEmpty) {<p>No results.</p>}
  }
 }
 </p>
 <p>You can also access <a href='@routes.Application.search(q=(if(!q.isEmpty) q else "*"), from=from, format="json")'>this data</a> using our <a href="@routes.Application.api()">API</a>.</p>
}